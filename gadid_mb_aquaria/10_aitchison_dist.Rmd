---
title: "extra code"
output: html_document
date: "2024-03-12"
---

okay, i need to rethink this (again) - my goal is aitchison distances comparing qm read proporitons to true biomass proportions in my aquarium tanks 

- also want to plot true vs observed for simple, raw, and mock (i did this for mock on another script...) 
- and calculate fold error rates for simple, raw, and mock

```{r}
library(tidyverse)
library(ggplot2)
library(compositions)
select <- dplyr::select
rename <- dplyr::rename
```


the data i need: 

read in tank estimates
```{r}
tanks_mock <- read.csv("/home/kimberly.ledger/gadid_aquaria/gadid_mb_aquaria/tank_mock_estimates.csv") %>%
  mutate(Species = ifelse(Species == "Boreogadus saida", "AC", Species),
         Species = ifelse(Species == "Gadus chalcogrammus", "WP", Species),
         Species = ifelse(Species == "Gadus macrocephalus", "PC", Species))

tanks_raw <- read.csv("/home/kimberly.ledger/gadid_aquaria/gadid_mb_aquaria/tank_raw_estimates.csv") %>%
        mutate(Species = ifelse(Species == "Boreogadus saida", "AC", Species),
         Species = ifelse(Species == "Gadus chalcogrammus", "WP", Species),
         Species = ifelse(Species == "Gadus macrocephalus", "PC", Species))
```

read in tank metadata 
```{r}
metadata <-  read.csv("/home/kimberly.ledger/gadid_aquaria/gadid_mb_aquaria/TankData_MBmodified.csv") %>% 
  filter(groupID != "T") %>%  #remove tap water controls
  select(!sampleID) %>% #remove sample id because estimates are at the tank-level
  unique() %>%
  rename(tank_ID = groupID)
```

join - this removes the few T tanks with eDNA reads
```{r}
all_mock <- metadata %>%
  pivot_longer(cols = c(19:21), names_to = "Species", values_to = "Fbiomass") %>%
  mutate(Species = str_remove(Species, "_Fbiomass")) %>%
  left_join(tanks_mock, by = c("tank_ID", "Species"))
all_raw <- metadata %>%
  pivot_longer(cols = c(19:21), names_to = "Species", values_to = "Fbiomass") %>%
  mutate(Species = str_remove(Species, "_Fbiomass")) %>%
  left_join(tanks_raw, by = c("tank_ID", "Species"))
```

filter to remove no fish tanks and tanks with high dissimilarity 
```{r}
mock_filtered <- all_mock %>%
  filter(n.tank.dissim != "2") %>%
  filter(Fish_pres == "1") %>%
  filter(N_spp > 1)

raw_filtered <- all_raw %>%
  filter(n.tank.dissim != "2") %>%
  filter(Fish_pres == "1") %>%
  filter(N_spp > 1)
```

make true.matrix
```{r}
true.mat <- mock_filtered %>% 
  select(Species, tank_ID, Fbiomass) %>%
  pivot_wider(values_from = "Fbiomass", names_from = "Species") %>%
  as.data.frame()

rownames(true.mat) <- true.mat$tank_ID
true.mat <-  true.mat %>% ungroup() %>% dplyr::select(-tank_ID)
```

make containers for outputs
```{r}
# Make containers for each type of output
make.cont <- function(dat){
  #out <-  matrix(0,max(dat$comm_idx),max(dat$sp_idx))
  out <-  matrix(0,31,3)                                       ## change to be number of tanks and spp
  rownames(out) <- dat %>% distinct(tank_ID) %>% pull(tank_ID)
  colnames(out) <- dat %>% distinct(Species) %>% pull(Species)
  return(out)
}

mock1.out <- make.cont(mock_filtered)
mock.sp   <- data.frame(Species=mock_filtered %>% distinct(Species) %>% pull(Species))
mock.comm <- data.frame(community=mock_filtered %>% distinct(tank_ID) %>% pull(tank_ID))

raw1.out <- make.cont(raw_filtered)
raw.sp   <- data.frame(Species=raw_filtered %>% distinct(Species) %>% pull(Species))
raw.comm <- data.frame(community=raw_filtered %>% distinct(tank_ID) %>% pull(tank_ID))
```

```{r}
library(coda.base)
#library(robCompositions)  #won't install, dependency "VIM" not available... 

# loop over mock1
mock1.AD <- data.frame(AD = rep(0,nrow(true.mat)))
rownames(mock1.AD) <- rownames(true.mat)

# loop over raw
raw1.AD <- data.frame(AD = rep(0,nrow(true.mat)))
rownames(raw1.AD) <- rownames(true.mat)

m_tanks <- mock_filtered %>%
  select(tank_ID, Species, Mean) %>%
  pivot_wider(names_from = "Species", values_from = "Mean") %>%
  as.data.frame()

r_tanks <- raw_filtered %>%
  select(tank_ID, Species, Mean) %>%
  pivot_wider(names_from = "Species", values_from = "Mean") %>%
  as.data.frame()

rownames(m_tanks) <- m_tanks$tank_ID
m_tanks <-  m_tanks %>% dplyr::select(-tank_ID)

rownames(r_tanks) <- r_tanks$tank_ID
r_tanks <-  r_tanks %>% dplyr::select(-tank_ID)

for(i in 1:nrow(m_tanks)){
  mock.a <- m_tanks[i,] %>% as.data.frame()
  
  for(j in 1:nrow(mock.a)){
    these <- which(true.mat[j,]>0)
    true <- true.mat[j,these]
    mock.c <- mock.a[j,these] / sum(mock.a[j,these])
    
    mock1.AD[i,"AD"] <-  dist(rbind(true,mock.c), method = "aitchison")
  }
  #print(i)
}

mock1.AD$model <- "mock1"   #aitchison distances on qm read proportions for tanks w/ 2 or more fish species 


for(i in 1:nrow(r_tanks)){
  raw.a <- r_tanks[i,] %>% as.data.frame()
  
  for(j in 1:nrow(raw.a)){
    these <- which(true.mat[j,]>0)
    true <- true.mat[j,these]
    raw.c <- raw.a[j,these] / sum(raw.a[j,these])
    
    raw1.AD[i,"AD"] <-  dist(rbind(true,raw.c), method = "aitchison")
  }
  #print(i)
}

raw1.AD$model <- "raw1"   #aitchison distances on non-qm read proportions for tanks w/ 2 or more fish species 
```


plot aitchinson distances 
```{r}
raw1.AD$community <- rownames(raw1.AD)
mock1.AD$community <- rownames(mock1.AD)

all.AD <- bind_rows(raw1.AD,mock1.AD)

#all.AD <- all.AD %>% 
#              pivot_longer(.,-model,
#                           names_to="community",
#                           values_to = "val")

all.AD <- all.AD %>%
                mutate(offset.plot = 0,
                       offset.plot = ifelse(model=="raw1",-0.05,offset.plot)) %>%
                mutate(Calibration = case_when(model=="raw1"~"None",
                             model=="mock1"~"Mock")) %>%
                as.data.frame()

all.AD$comm.idx = as.numeric(as.factor(all.AD$community))
                


xBREAKS <- all.AD %>% distinct(comm.idx,community)
yBREAKS <- c(0:31)

col.val <- pal_jco(palette = c("default"), alpha = 1)(10)[c(6,7)]

p_AD <- ggplot(all.AD) + # %>% 
          #geom_errorbar(aes(x=comm.idx + offset.plot,ymin=q.025,ymax=q.975,color=Calibration),width=0) +
          #geom_errorbar(aes(x=comm.idx + offset.plot,ymin=q.25,ymax=q.75,color=Calibration),size=2,width=0) +        
          geom_point(aes(x=comm.idx + offset.plot,y=AD,color=Calibration),shape =21,fill="white",size=2) +
          #scale_y_continuous(NULL,expand=c(0,NA),limits=c(0,NA),breaks=yBREAKS) +
          #scale_shape_manual(values=c(21,22,24)) +
          scale_fill_manual(values=col.val,"Community") +
          scale_color_manual(values=col.val,"Calibration") +
          scale_x_continuous(NULL,breaks=xBREAKS$comm.idx,labels=xBREAKS$community,limits=c(NA,31.3)) +
          ylab("Aitchison distance") +
          theme_classic() +
          theme(legend.position = c(0.4755,0.85),
                plot.margin = margin(0,0,0,0.85,"lines"),
                legend.key.size=unit(0.1,'lines'),
                legend.text=element_text(size=7),
                legend.title=element_text(size=9))
          
p_AD


#ggsave(p_AD, filename = "/home/kimberly.ledger/gadid_metabarcoding/mock_community/mockcom_comparison/gadid_even_aitchison.jpg", width = 6, height = 5, units = "in")
```


okay, this is interesting.. 
```{r}
all.AD %>%
  group_by(Calibration) %>%
  summarize(mean_AD = mean(AD),
            sd_AD = sd(AD)) 
```


is there any pattern to when mock does do better than raw? 
```{r}
temp <- all.AD %>%
  select(AD, model, community) %>%
  pivot_wider(names_from = "model", values_from = "AD") %>%
  mutate(better = ifelse(mock1 < raw1, "mock", "raw")) %>%
  rename(tank_ID = community) %>%
  left_join(metadata, by = "tank_ID")

mock_better <- temp %>%
  filter(better == "mock")   ## 11 tanks - wp present in all of these and pc in all but one

raw_better <- temp %>%
  filter(better == "raw") ## 20 tanks - ac present in all 
```


