---
title: "compare modeled qPCR results to true pollock biomass"
author: "Kimberly Ledger"
date: "2024-02-14"
output: html_document
---

clear environment
```{r}
rm(list=ls())
```

load libraries
```{r}
library(tidyverse)
select <- dplyr::select
rename <- dplyr::rename
```


load data
```{r}
load("~/gadid_aquaria/qPCR_pollock/pcod_qPCR_fitted_20240222.RData")

tank_metadata <- read.csv("~/gadid_aquaria/qPCR_pollock/data/TankData_MBmodified.csv") %>%
  rename(site_name = groupID) %>%
  select(!sampleID) %>%
  unique()
```

get qPCR estimates from fitted model output
```{r}
pollock_qPCR <- Output.qpcr$SITE_MONTH_summary
```

combine 
```{r}
my_data <- pollock_qPCR %>%
  select(!month) %>%
  left_join(tank_metadata, by = "site_name")
```

filter tank results 
```{r}
my_data_filtered <- my_data %>%
  filter(site_name != 34) %>%    ## remove two Pole Barn tanks with different flow rates/tank volumes
  filter(site_name != 7)
```


look at the copy number estimates for pollock qPCR - this is copies per reaction
```{r}
temp <- my_data_filtered %>%
  mutate(copy_num_mean = 10^MEAN) 

min(temp$copy_num_mean)
max(temp$copy_num_mean)
mean(temp$copy_num_mean)
```

plot qPCR model output 
```{r}
my_data %>%
   ggplot() + 
   geom_point(aes(x=WP_biomass, y=10^MEAN, color = site_name)) + 
   geom_errorbar(aes(x=WP_biomass, y=10^MEAN, ymin = 10^q.05, ymax = 10^q.95, color = site_name))  +
  labs(x = "biomass (grams)",
       y = "DNA copy number per reaction") + 
  theme_classic() 

my_data_filtered %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=10^MEAN, color = site_name)) + 
  geom_errorbar(aes(x=WP_biomass, y=10^MEAN, ymin = 10^q.05, ymax = 10^q.95, color = site_name)) +
  labs(x = "biomass (grams)",
       y = "DNA copy number per reaction") + 
  theme_classic()
```

add column for log10(biomass)
```{r}
my_data_filtered$log_WP_biomass <- log10(my_data_filtered$WP_biomass)
```


run models with log and non-log variables
```{r}
mod1 <- lm(MEAN ~ log_WP_biomass, data = my_data_filtered)
summary(mod1)

mod1_int0 <- lm(MEAN ~ log_WP_biomass -1, data = my_data_filtered)
summary(mod1_int0)

mod2 <- lm(10^MEAN ~ WP_biomass, data = my_data_filtered)
summary(mod2)

mod2_int0 <- lm(10^MEAN ~ WP_biomass-1, data = my_data_filtered)
summary(mod2_int0)
```

calculate grand mean and 95% CI 
```{r}
wp <- my_data_filtered %>%
  mutate(label = "individual") %>%
  mutate(log_copy_mean = MEAN,
         log_copy_q.05 = q.05,
         log_copy_q.95 = q.95) %>%
  mutate(copy_mean = 10^MEAN,
         copy_q.05 = 10^q.05,
         copy_q.95 = 10^q.95)

wp_mean <- wp %>%
  group_by(WP_biomass) %>%
  summarize(x_copy_mean = mean(copy_mean),
            copy_q.05 = quantile(copy_mean,probs=0.05),
            copy_q.95 = quantile(copy_mean,probs=0.95),
            x_log_copy_mean = mean(log_copy_mean),
            log_copy_q.05 = quantile(log_copy_mean,probs=0.05),
            log_copy_q.95 = quantile(log_copy_mean,probs=0.95)) %>%
  mutate(label = "mean") %>%
  rename(copy_mean = x_copy_mean,
         log_copy_mean = x_log_copy_mean)
            
wp_w_mean <- wp %>%
  bind_rows(wp_mean) %>%
  mutate(log_WP_biomass = ifelse(label == "mean", log10(WP_biomass), log_WP_biomass))
```

plot on non-log scales
```{r}
wp_w_mean %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=copy_mean, color = label)) + 
  geom_errorbar(aes(x=WP_biomass, y=copy_mean, ymin = copy_q.05, ymax = copy_q.95, color = label)) +
  theme_classic() + 
  scale_color_manual(values = c("grey", "black")) + 
  geom_abline(slope = coef(mod2_int0)[1], intercept = 0, color = "black", linetype = "dashed") +
  geom_abline(slope = coef(mod2)[2], intercept = coef(mod2)[1], color = "blue", linetype = "dashed") +
  labs(x = "Walleye pollock biomass (grams)",
       y = "DNA concentration (copies per reaction)", 
       color = "tank ID") +
   xlim(0, 4000)
```


now plot on log-log scale
```{r}
wp_w_mean %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=copy_mean, color = label)) 

wp_w_mean %>%
  ggplot() + 
  geom_point(aes(x=log_WP_biomass, y=log_copy_mean, color = label)) + 
  geom_errorbar(aes(x=log_WP_biomass, y=log_copy_mean, ymin = log_copy_q.05, ymax = log_copy_q.95, color = label)) +
  theme_classic() + 
  scale_color_manual(values = c("grey", "black")) + 
  geom_abline(slope = coef(mod1)[2], intercept = coef(mod1)[1], color = "blue", linetype = "dashed") +
  geom_abline(slope = coef(mod1_int0)[1], intercept = 0, color = "black", linetype = "dashed") +
  labs(x = "log10 Walleye pollock biomass (grams)",
       y = "log10 DNA concentration (copies per reaction)", 
       color = "tank ID") + 
 xlim(0, 3.75) +
  ylim(0, 3.5)
```

black - intercept set to 0; blue - intercept not zero

okay, i want to go with a figure on the non-log scale 

 
## supplemental figure B1
let's plot without individual CI's
```{r}
wp <- my_data_filtered %>%
  mutate(label = "individual") %>%
  mutate(copy_mean = 10^MEAN)

wp_mean <- wp %>%
  group_by(WP_biomass) %>%
  summarize(x_copy_mean = mean(copy_mean),
            copy_q.05 = quantile(copy_mean,probs=0.05),
            copy_q.95 = quantile(copy_mean,probs=0.95)) %>%
  mutate(label = "mean") %>%
  rename(copy_mean = x_copy_mean)

wp_w_mean <- wp %>%
  bind_rows(wp_mean)

wp_qPCR <- wp_w_mean %>%
  ggplot() +
  geom_point(aes(x=WP_biomass, y=copy_mean, color = label), cex = 2) +
  geom_errorbar(aes(x=WP_biomass, y=copy_mean, ymin = copy_q.05, ymax = copy_q.95, color = label), width = 0) +
  theme_classic() +
  scale_color_manual(values = c("grey", "black")) +
  geom_abline(slope = coef(mod2)[2], intercept = coef(mod2)[1], color = "black", linetype = "dashed") +
  labs(x = "Walleye pollock biomass (grams)",
       y = "DNA concentration (copies per reaction)",
       color = "tank") +
   xlim(0, 4000)
 wp_qPCR
```

```{r}
#ggsave("my_figures/pollock_qpcr.png", plot = , width = 6, height = 4, dpi = 300)
```


### my next goal is to use these qPCR copy number estimates to transform the metabarcoding read proportions out of the proportional data space 

adapted from Allen et al. 2023: convert these proportions into absolute abundances by expansion, using the qPCR results for our reference species, walleye pollock. We estimated the total amplifiable cod DNA (pollock, pcod, and arctic cod) in aquaria sample as C(amplifiable) = C(qPCR of reference)/Proportion(reference), where C has units of DNA copies per microliter and then expanded species' proportions into absolute concentrations by multiplying these sample-specific total concentrations by individual species' proportions, such that for species j in sample i, C(i,j) = C(amplifiable) * Proportion i,j

load quantitative metabarcoding read proportion 
```{r}
metabar <- read.csv("~/gadid_aquaria/gadid_mb_aquaria/tank_mock_estimates.csv") %>%
  filter(tank_ID %in% my_data_filtered$site_name) #%>%
  #filter(n.tank.dissim == 0) #one tank (40) has tank dissimilarity flags from mb - will remove this from the analysis
```

keep just the pollock metabarcoding results
```{r}
pollock_metabar <- metabar %>%
  filter(Species == "Gadus chalcogrammus") %>%
  rename(site_name = tank_ID)
```


calculate C(amplifiable) = C(qPCR of reference)/Proportion(reference) - this uses log10 versions of copy number
```{r}
# C_amp_logconc <- pollock_metabar %>%
#   left_join(my_data_filtered, by = "site_name") %>%
#   mutate(C_amp_mean = MEAN/Mean) %>% #  ,
#         # C_amp_q.025 = q.025.y/q.025.x,         ### need to figure out how to handle quartiles 
#         # C_amp_median = Median.y/Median.x,
#         # C_amp_q.975 = q.975.y/q.975.x) %>%  
#   #select(site_name, C_amp_mean, C_amp_q.025, C_amp_median, C_amp_q.975)
#   select(site_name, C_amp_mean)
```

calculate C(amplifiable) = C(qPCR of reference)/Proportion(reference)
do this for non-log10 estimates of qPCR concentration 
```{r}
C_amp_absconc <- pollock_metabar %>%
  left_join(my_data_filtered, by = "site_name") %>%
  mutate(pollockdna = 10^MEAN) %>%
  mutate(C_amp_mean = pollockdna/Mean) %>% #,
         #C_amp_q.025 = (10^q.025.y)/q.025.x,
         #C_amp_median = (10^Median.y)/Median.x,
         #C_amp_q.975 = (10^q.975.y)/q.975.x) %>%  
  #select(site_name, C_amp_mean, C_amp_q.025, C_amp_median, C_amp_q.975)
  select(site_name, C_amp_mean)
```


join back to full metabarcoding results and calculate DNA concentration by species and tank 
```{r}
# all_metabar_logconc <- metabar %>%
#   rename(site_name = tank_ID) %>%
#   left_join(C_amp_logconc) %>%
#   mutate(Conc_mean = C_amp_mean*Mean) #,
#          #Conc_q.025 = C_amp_q.025*q.025,
#          #Conc_median = C_amp_median*Median,
#          #Conc_q.975 = C_amp_q.975*q.975)

all_metabar_absconc <- metabar %>%
  rename(site_name = tank_ID) %>%
  left_join(C_amp_absconc) %>%
  mutate(Conc_mean = C_amp_mean*Mean) #,
         #Conc_q.025 = C_amp_q.025*q.025,
         #Conc_median = C_amp_median*Median,
         #Conc_q.975 = C_amp_q.975*q.975)
```

are these the same thing??? 
```{r}
#all_metabar_logconc$temp <- 10^all_metabar_logconc$Conc_mean
```

okay, values are no longer the same thing... need to figure out which one is correct to be using
but i have the feeling it's the absconc table. 

join back to the tank metadata
```{r}
tank_metadata_biomass <- tank_metadata %>%
  select(site_name, AC_biomass, PC_biomass, WP_biomass) %>% 
  pivot_longer(cols = c(2:4), names_to = "Species", values_to = "biomass") %>%
  mutate(Species = str_remove(Species, "_biomass")) %>%
  mutate(Species = ifelse(Species == "AC", "Boreogadus saida",  Species),
         Species = ifelse(Species == "WP", "Gadus chalcogrammus", Species),
         Species = ifelse(Species == "PC", "Gadus macrocephalus", Species))

tank_metadata_abundance <- tank_metadata %>%
  select(site_name, AC_N, PC_N, WP_N) %>% 
  pivot_longer(cols = c(2:4), names_to = "Species", values_to = "N") %>%
  mutate(Species = str_remove(Species, "_N")) %>%
  mutate(N = ifelse(is.na(N), 0, N)) %>%
  mutate(Species = ifelse(Species == "AC", "Boreogadus saida",  Species),
         Species = ifelse(Species == "WP", "Gadus chalcogrammus", Species),
         Species = ifelse(Species == "PC", "Gadus macrocephalus", Species))

# combined_logconc <- all_metabar_logconc %>%
#   left_join(tank_metadata_biomass, by = c("site_name", "Species")) %>%
#   left_join(tank_metadata_abundance, by = c("site_name", "Species")) %>%
#   mutate(Species = ifelse(Species == "Boreogadus saida", "Arctic cod", Species),
#          Species = ifelse(Species == "Gadus chalcogrammus", "Walleye pollock", Species),
#          Species = ifelse(Species == "Gadus macrocephalus", "Pacific cod", Species))

combined_absconc <- all_metabar_absconc %>%
  left_join(tank_metadata_biomass, by = c("site_name", "Species")) %>%
  left_join(tank_metadata_abundance, by = c("site_name", "Species")) %>%
  mutate(Species = ifelse(Species == "Boreogadus saida", "Arctic cod", Species),
         Species = ifelse(Species == "Gadus chalcogrammus", "Walleye pollock", Species),
         Species = ifelse(Species == "Gadus macrocephalus", "Pacific cod", Species)) %>%
  mutate(ind_biomass = biomass/N)
```

calcuate eDNA release rate per fish body weight
```{r, fig.width=3, fig.height=2.5}
release <- combined_absconc %>%
  filter(Species == "Pacific cod") %>%
  mutate(release = Conc_mean/N/ind_biomass) %>%
  filter(N > 0)

ggplot(data = release, aes(x=ind_biomass, y = release)) +
  geom_point(cex = 2) +
  theme_classic() + 
  labs(x = "individual biomass (grams)",
       y = "DNA release rate (copies per fish per mass)") 
```



the moment of truth.... plot vs biomass - first using log-conc
```{r}
# mypal <- c("#6a6599", "#79af97", "#00a1d5")   #purple, green, blue
# 
# combined_logconc %>%
#   #filter(biomass < 5000) %>%
#   filter(biomass > 0) %>%
#   ggplot() + 
#   geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species), cex = 2) + 
#   #geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
#   geom_smooth(aes(x=log10(biomass),y=Conc_mean,color=Species), method = "lm", formula = y ~ x, se = FALSE, linetype = "dashed") + 
#   geom_smooth(aes(x=log10(biomass),y=Conc_mean,color=Species), method = "lm", formula = y ~ x -1, se = FALSE) + 
#   theme_classic() + 
#   scale_color_manual(values = mypal) + 
#   labs(x = "log10(biomass)",
#        y = "log10(DNA copy number)") 
```


the moment of truth.... plot vs biomass - first using absconc
```{r}
mypal <- c("#6a6599", "#79af97", "#00a1d5")   #purple, green, blue

combined_absconc %>%
  #filter(biomass < 5000) %>%
  #filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=biomass, y=Conc_mean, color = Species), cex = 2) + 
  #geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  geom_smooth(aes(x=biomass,y=Conc_mean,color=Species), method = "lm", formula = y ~ x, se = FALSE, linetype = "dashed") + 
  #geom_smooth(aes(x=biomass,y=Conc_mean,color=Species), method = "lm", formula = y ~ x -1, se = FALSE) + 
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "biomass",
       y = "DNA copy number") 
```


okay, since the species estimates are not independent, plot just one species at a time??? 
also run linear models 


arctic cod - biomass vs DNA copies  
```{r}
ac <- combined_absconc %>%
  filter(Species == "Arctic cod")#%>%
  #filter(biomass > 0)

mean(ac$Conc_mean)
median(ac$Conc_mean)
quantile(ac$Conc_mean, probs = 0.025)
quantile(ac$Conc_mean, probs = 0.975)

#ac_lm1 <- lm(Conc_mean ~ biomass-1, data = ac)
#summary(ac_lm1)

ac_lm2 <- lm(Conc_mean ~ biomass, data = ac)
summary(ac_lm2)

ac_plot <- ac %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = Species), cex = 2) +
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  geom_smooth(aes(x=biomass,y=Conc_mean), method = "lm", formula = y ~ x, se = FALSE, linetype = "dashed", color = "#6a6599") + 
  #geom_smooth(aes(x=biomass,y=Conc_mean), method = "lm", formula = y ~ x -1, se = FALSE,color = "#6a6599") + 
  theme_classic() +
  scale_color_manual(values = "#6a6599") +
  labs(x = "biomass (grams)",
       y = "DNA concentration (copies per reaction)",
        color = "") +
  theme(legend.position = "top") 
ac_plot
```

pacific cod - biomass vs DNA copies  
```{r}
pc <- combined_absconc %>%
  filter(Species == "Pacific cod")#%>%
  #filter(biomass > 0)

mean(pc$Conc_mean)
median(pc$Conc_mean)
quantile(pc$Conc_mean, probs = 0.025)
quantile(pc$Conc_mean, probs = 0.975)

#pc_lm1 <- lm(Conc_mean ~ biomass-1, data = pc)
#summary(pc_lm1)

pc_lm2 <- lm(Conc_mean ~ biomass, data = pc)
summary(pc_lm2)

pc_plot <- pc %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = Species), cex = 2) +
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  geom_smooth(aes(x=biomass,y=Conc_mean), method = "lm", formula = y ~ x, se = FALSE, linetype = "dashed", color = "#79af97") + 
  #geom_smooth(aes(x=biomass,y=Conc_mean), method = "lm", formula = y ~ x -1, se = FALSE,color = "#79af97") + 
  theme_classic() +
  scale_color_manual(values = "#79af97") +
  labs(x = "biomass (grams)",
       y = "DNA concentration (copies per reaction)",
        color = "") +
  theme(legend.position = "top")
pc_plot
```


combine plots
```{r, fig.width=10, fig.height=4}
library(patchwork)

combined_fig <- ac_plot + pc_plot + plot_layout(guides = 'keep') + plot_annotation(tag_levels = 'A') &
    theme(plot.tag = element_text(face = 'bold'))
combined_fig
```

```{r}
ggsave("my_figures/ac_pc_estimates_all.png", plot = combined_fig, width = 8, height = 4, dpi = 300)
```



okay, i'm curious how a few of the tank variables may be influencing our relationships
1. temperature
2. number of species
3. dominate species 

```{r}
some_metadata <- my_data_filtered %>%
  select(site_name, Temp, N_spp, AC_Fbiomass, PC_Fbiomass, WP_Fbiomass, TankTime) %>%
  mutate(dominate = ifelse(AC_Fbiomass > PC_Fbiomass, "Arctic cod", NA),
         dominate = ifelse(WP_Fbiomass > AC_Fbiomass, "Walleye pollock", dominate),
         dominate = ifelse(PC_Fbiomass > WP_Fbiomass, "Pacific cod", dominate)) %>%
  select(site_name, Temp, N_spp, dominate, WP_Fbiomass, TankTime)
```


also explore tank AD results 
```{r}
all.AD <- readRDS("/home/kimberly.ledger/gadid_aquaria/gadid_mb_aquaria/tank_ADs.RDS") %>%
  filter(model == "mock1") %>%
  rename(site_name = tank_ID)
```


```{r}
combined_absconc <- combined_absconc %>%
  left_join(some_metadata) %>%
  left_join(all.AD)

#combined_absconc$N_spp <- as.factor(combined_absconc$N_spp)
```

make a nicer version of figure
```{r}
library(viridis)

fig_AD <- combined_absconc %>%
  #filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = AD, shape = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = WP_Fbiomass), width = 0) +
  theme_classic() +
  scale_color_viridis() +
  #scale_color_gradient2(low = "darkgreen", mid = "darkgrey", high = "purple", midpoint = 0.5, limits = c(0, 1), breaks = c(0.25, 0.5, 0.75)) +
  labs(x = "biomass",
       y = "DNA copy number",
       color = "Aitchinson Distance")
fig_AD

fig_AD_binary <- combined_absconc %>%
  #filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  mutate(high_AD = ifelse(AD > 4, ">4", "<4")) %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = high_AD, shape = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = low_WP), width = 0) +
  scale_color_manual(values = c("lightblue", "darkblue")) +
  theme_classic() +
  #geom_smooth(aes(x=biomass,y=Conc, color = low_WP), formula = y ~ x - 1, linetype = "dashed", method = "lm", se = FALSE) +
  labs(x = "biomass",
       y = "DNA copy number",
       color = "Aitchinson Distance")
fig_AD_binary 
```


maybe just focus on error in WP proportion??? 
```{r}
# wp_error <- combined_absconc %>%
#   filter(Species == "Walleye pollock") %>%
#   mutate(error = abs(Mean - WP_Fbiomass)) %>%
#   mutate(relative = error/Mean) %>%
#   arrange(desc(relative)) %>%
#   select(site_name, relative)
# wp_error
# 
# wp_error_2 <- combined_absconc %>%
#   filter(Species == "Walleye pollock") %>%
#   mutate(error = abs(WP_Fbiomass - Mean)) %>%
#   mutate(relative = error/WP_Fbiomass) %>%
#   arrange(desc(relative)) %>%
#   select(site_name, relative)
# wp_error_2

wp_diff <- combined_absconc %>%
  filter(Species == "Walleye pollock") %>%
  mutate(difference = abs((Mean - WP_Fbiomass) / ((Mean + WP_Fbiomass)/2))) %>%
  arrange(desc(difference)) %>%
  select(site_name, difference)
wp_diff
```

```{r}
combined_absconc <- combined_absconc %>%
  left_join(wp_diff)

fig_WP_error <- combined_absconc %>%
  #filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = difference, shape = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = WP_Fbiomass), width = 0) +
  theme_classic() +
  scale_color_viridis() +
  #scale_color_gradient2(low = "darkgreen", mid = "darkgrey", high = "purple", midpoint = 0.5, limits = c(0, 1), breaks = c(0.25, 0.5, 0.75)) +
  labs(x = "biomass",
       y = "DNA copy number",
       color = "WP difference")
fig_WP_error

fig_WP_error_binary <- combined_absconc %>%
  #filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  mutate(WP_diff = ifelse(difference > 0.3, ">30%", "<30%")) %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = WP_diff, shape = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = low_WP), width = 0) +
  scale_color_manual(values = c("lightblue", "darkblue")) +
  theme_classic() +
  #geom_smooth(aes(x=biomass,y=Conc, color = low_WP), formula = y ~ x - 1, linetype = "dashed", method = "lm", se = FALSE) +
  labs(x = "biomass",
       y = "DNA copy number",
       color = "WP difference")
fig_WP_error_binary 
```





```{r}
fig_gradient <- combined_absconc %>%
  #filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = WP_Fbiomass, shape = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = WP_Fbiomass), width = 0) +
  theme_classic() +
  scale_color_viridis() +
  #scale_color_gradient2(low = "darkgreen", mid = "darkgrey", high = "purple", midpoint = 0.5, limits = c(0, 1), breaks = c(0.25, 0.5, 0.75)) +
  labs(x = "biomass",
       y = "DNA copy number",
       color = "Proportion of Walleye pollock biomass")
fig_gradient 

fig_binary <- combined_absconc %>%
  #filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  mutate(low_WP = ifelse(WP_Fbiomass < 0.25, "<0.25", ">=0.25")) %>%
  ggplot() +
  geom_point(aes(x=biomass, y=Conc_mean, color = low_WP, shape = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = low_WP), width = 0) +
  scale_color_manual(values = c("lightblue", "darkblue")) +
  theme_classic() +
  #geom_smooth(aes(x=biomass,y=Conc, color = low_WP), formula = y ~ x - 1, linetype = "dashed", method = "lm", se = FALSE) +
  labs(x = "biomass",
       y = "DNA copy number",
       color = "Proportion of Walleye pollock biomass")
fig_binary 
```


```{r}
#ggsave("my_figures/bm_cn_wp_gradient.png", plot = fig_gradient, width = 8, height = 4, dpi = 300)
#ggsave("my_figures/bm_cn_wp_binary.png", plot = fig_binary, width = 8, height = 4, dpi = 300)
```

remake ac and pc figures/linear model and remove tanks with <25% WP biomass 

```{r}
ac_reduced <- combined_absconc %>%
  filter(Species == "Arctic cod") %>%
  #filter(biomass > 0) %>%
  filter(difference < 0.3)

mean(ac$Conc_mean)
median(ac$Conc_mean)
quantile(ac$Conc_mean, probs = 0.025)
quantile(ac$Conc_mean, probs = 0.975)

ac_lm3 <- lm(Conc_mean ~ biomass, data = ac_reduced)
summary(ac_lm3)

ac_plot_reduced <- ac_reduced %>%  
  ggplot() + 
  geom_point(aes(x=biomass, y=Conc_mean, color = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  geom_smooth(aes(x=biomass,y=Conc_mean), method = "lm", formula = y ~ x, se = FALSE, color = "#6a6599", linetype = "dashed") +
  theme_classic() + 
  scale_color_manual(values = "#6a6599") + 
  labs(x = "biomass (grams)",
       y = "DNA concentration (copies per reaction)",
       color = "") +
  theme(legend.position = "top")
ac_plot_reduced
```

```{r}
pc_reduced <- combined_absconc %>%
  filter(Species == "Pacific cod") %>%
  #filter(biomass > 0) %>%
  filter(difference < 0.3)  

pc_lm3 <- lm(Conc_mean ~ biomass, data = pc_reduced)
summary(pc_lm3)

pc_plot_reduced <- pc_reduced %>%  
  ggplot() + 
  geom_point(aes(x=biomass, y=Conc_mean, color = Species), cex = 2) + 
  #geom_errorbar(aes(x=biomass, y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  geom_smooth(aes(x=biomass,y=Conc_mean), method = "lm", formula = y ~ x, se = FALSE, color = "#79af97", linetype = "dashed") +
  #geom_abline(slope = coef(pc_lm3)[2], intercept = coef(pc_lm3)[1], color = "blpck", linetype = "dashed") +
  theme_classic() + 
  scale_color_manual(values = "#79af97") + 
  labs(x = "biomass (grams)",
       y = "DNA concentration (copies per reaction)",
       color = "") +
  theme(legend.position = "top")
pc_plot_reduced
```

plot all together
```{r}
combined_absconc %>%
  #filter(biomass < 5000) %>%
  #filter(biomass > 0) %>%
  filter(difference < 0.3) %>%
  ggplot() + 
  geom_point(aes(x=biomass, y=Conc_mean, color = Species), cex = 2) + 
  #geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  geom_smooth(aes(x=biomass,y=Conc_mean,color=Species), method = "lm", formula = y ~ x, se = FALSE, linetype = "dashed") + 
  #geom_smooth(aes(x=biomass,y=Conc_mean,color=Species), method = "lm", formula = y ~ x -1, se = FALSE) + 
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "biomass",
       y = "DNA copy number") 
```


combine plots
```{r, fig.width=10, fig.height=4}
library(patchwork)

reduced_fig <- ac_plot_reduced + pc_plot_reduced + plot_layout(guides = 'keep') + plot_annotation(tag_levels = 'A') &
    theme(plot.tag = element_text(face = 'bold'))
reduced_fig
```

```{r}
ggsave("my_figures/ac_pc_estimates_updated.png", plot = reduced_fig, width = 8, height = 4, dpi = 300)
```

