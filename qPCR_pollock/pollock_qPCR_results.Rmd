---
title: "compare modeled qPCR results to true pollock biomass"
author: "Kimberly Ledger"
date: "2024-02-14"
output: html_document
---

clear environment
```{r}
rm(list=ls())
```

load libraries
```{r}
library(tidyverse)
select <- dplyr::select
rename <- dplyr::rename
```


load data
```{r}
#load("~/gadid_aquaria/qPCR_pollock/pcod_qPCR_fitted_20240216.RData")
load("~/gadid_aquaria/qPCR_pollock/pcod_qPCR_fitted_20240222.RData")

tank_metadata <- read.csv("~/gadid_aquaria/qPCR_pollock/data/TankData_MBmodified.csv") %>%
  rename(site_name = groupID) %>%
  select(!sampleID) %>%
  unique()
```

get qPCR estimates from fitted model output
```{r}
pollock_qPCR <- Output.qpcr$SITE_MONTH_summary
```

combine 
```{r}
my_data <- pollock_qPCR %>%
  select(!month) %>%
  left_join(tank_metadata, by = "site_name")
```

filter tank results 
```{r}
my_data_filtered <- my_data %>%
  filter(site_name != 34) %>%    ## remove two Pole Barn tanks with different flow rates/tank volumes
  filter(site_name != 7)

arena_only <- my_data %>%
  filter(lab == "Arena")
```


look at the copy number estimates 
```{r}
temp <- my_data_filtered %>%
  mutate(copy_num_mean = 10^MEAN) 

min(temp$copy_num_mean)
max(temp$copy_num_mean)
mean(temp$copy_num_mean)
```


plot qPCR model output 
```{r}
my_data %>%
   ggplot() + 
   geom_point(aes(x=WP_biomass, y=MEAN, color = site_name)) + 
   geom_errorbar(aes(x=WP_biomass, y=MEAN, ymin = q.05, ymax = q.95, color = site_name)) #+
   #scale_x_log10()

my_data_filtered %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=MEAN, color = site_name)) + 
  geom_errorbar(aes(x=WP_biomass, y=MEAN, ymin = q.05, ymax = q.95, color = site_name)) +
  labs(x = "biomass (grams)",
       y = "log10 DNA copy number") + 
  theme_classic() #+
  #scale_x_log10()

#my_data_filtered %>%
#  ggplot() + 
#  geom_point(aes(x=WP_biomass, y=MEAN, color = site_name)) + 
#  geom_errorbar(aes(x=WP_biomass, y=MEAN, ymin = q.05, ymax = q.95, color = site_name)) +
#  scale_x_log10()

# arena_only%>%
#    ggplot() + 
#    geom_point(aes(x=WP_biomass, y=MEAN, color = site_name)) + 
#    geom_errorbar(aes(x=WP_biomass, y=MEAN, ymin = q.05, ymax = q.95, color = site_name)) #+
#   scale_x_log10()
```


```{r}
mod2 <- lm(10^MEAN ~ WP_biomass-1, data = my_data_filtered)
summary(mod2)
```

calculate grand mean and 95% CI 
```{r}
wp <- my_data_filtered %>%
  mutate(label = "individual") %>%
  mutate(copy_mean = 10^MEAN,
         copy_q.05 = 10^q.05,
         copy_q.95 = 10^q.95)

wp_mean <- wp %>%
  group_by(WP_biomass) %>%
  summarize(x_copy_mean = mean(copy_mean),
            copy_q.05 = quantile(copy_mean,probs=0.05),
            copy_q.95 = quantile(copy_mean,probs=0.95)) %>%
  mutate(label = "mean") %>%
  rename(copy_mean = x_copy_mean)
            
wp_w_mean <- wp %>%
  bind_rows(wp_mean)

wp_w_mean %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=copy_mean, color = label)) + 
  geom_errorbar(aes(x=WP_biomass, y=copy_mean, ymin = copy_q.05, ymax = copy_q.95, color = label)) +
  theme_classic() + 
  scale_color_manual(values = c("grey", "black")) + 
  geom_abline(slope = coef(mod2)[1], intercept = 0, color = "black", linetype = "dashed") +
  labs(x = "Walleye pollock biomass (grams)",
       y = "DNA concentration (copies per liter)", 
       color = "tank ID") +
   xlim(0, 4000)
            
#            SD=sd(mock1.mean),
#                 q.025 = quantile(mock1.mean,probs=0.025),
#                 #q.05 = quantile(mock1.mean,probs=0.05),
#                 #q.25 = quantile(mock1.mean,probs=0.25),
#                 #q.75 = quantile(mock1.mean,probs=0.75),
#                 #q.95 = quantile(mock1.mean,probs=0.95),
#                 q.975 = quantile(mock1.mean,probs=0.975))
```

let's plot without individual CI's
```{r}
wp <- my_data_filtered %>%
  mutate(label = "individual") %>%
  mutate(copy_mean = 10^MEAN)

wp_mean <- wp %>%
  group_by(WP_biomass) %>%
  summarize(x_copy_mean = mean(copy_mean),
            copy_q.05 = quantile(copy_mean,probs=0.05),
            copy_q.95 = quantile(copy_mean,probs=0.95)) %>%
  mutate(label = "mean") %>%
  rename(copy_mean = x_copy_mean)
            
wp_w_mean <- wp %>%
  bind_rows(wp_mean)

wp_qPCR <- wp_w_mean %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=copy_mean, color = label), cex = 2) + 
  geom_errorbar(aes(x=WP_biomass, y=copy_mean, ymin = copy_q.05, ymax = copy_q.95, color = label), width = 0) +
  theme_classic() + 
  scale_color_manual(values = c("grey", "black")) + 
  geom_abline(slope = coef(mod2)[1], intercept = 0, color = "black", linetype = "dashed") +
  labs(x = "Walleye pollock biomass (grams)",
       y = "DNA concentration (copies per liter)", 
       color = "tank") +
   xlim(0, 4000)
 wp_qPCR         
```

```{r}
#ggsave("my_figures/pollock_qpcr.png", plot = , width = 6, height = 4, dpi = 300)
```


older plot versions
```{r}
my_data_filtered %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=10^MEAN, color = site_name)) + 
  #scale_x_log10() +
  theme_classic() + 
  geom_abline(slope = coef(mod2)[1], intercept = 0, color = "black", linetype = "dashed") +
  #geom_smooth(aes(x=WP_biomass,y=10^MEAN), color = "grey", linetype = "dashed", method = "lm", se = FALSE) +
  labs(x = "Walleye pollock biomass (grams)",
       y = "DNA concentration (copies per liter)", 
       color = "tank ID") +
   xlim(0, 4000)

my_data_filtered %>%
  ggplot() + 
  geom_point(aes(x=WP_biomass, y=10^MEAN, color = site_name)) + 
  geom_errorbar(aes(x=WP_biomass, y=10^MEAN, ymin = 10^q.05, ymax = 10^q.95, color = site_name)) #+
  #scale_x_log10()
```




### my next goal is to use these qPCR copy number estimates to transform the metabarcoding read proportions out of the proportional data space 

adapted from Allen et al. 2023: convert these proportions into absolute abundances by expansion, using the qPCR results for our reference species, walleye pollock. We estimated the total amplifiable cod DNA (pollock, pcod, and arctic cod) in aquaria sample as C(amplifiable) = C(qPCR of reference)/Proportion(reference), where C has units of DNA copies per microliter and then expanded species' proportions into absolute concentrations by multiplying these sample-specific total concentrations by individual species' proportions, such that for species j in sample i, C(i,j) = C(amplifiable) * Proportion i,j

load quantitative metabarcoding read proportion 
```{r}
metabar <- read.csv("~/gadid_aquaria/gadid_mb_aquaria/tank_mock_estimates.csv") %>%
  filter(tank_ID %in% my_data_filtered$site_name)
```

one tank (40) has tank dissimilarity flags from mb.  come back and look at this. 
```{r}
pollock_metabar <- metabar %>%
  filter(Species == "Gadus chalcogrammus") %>%
  rename(site_name = tank_ID)
```

calculate C(amplifiable) = C(qPCR of reference)/Proportion(reference)
```{r}
C_amp <- pollock_metabar %>%
  left_join(my_data_filtered, by = "site_name") %>%
  mutate(C_amp_mean = MEAN/Mean,
         C_amp_q.025 = q.025.y/q.025.x,
         C_amp_median = Median.y/Median.x,
         C_amp_q.975 = q.975.y/q.975.x) %>%  
  select(site_name, C_amp_mean, C_amp_q.025, C_amp_median, C_amp_q.975)
```

join back to full metabarcoding results and calculate DNA concentration by species and tank 
```{r}
all_metabar <- metabar %>%
  rename(site_name = tank_ID) %>%
  left_join(C_amp) %>%
  mutate(Conc_mean = C_amp_mean*Mean,
         Conc_q.025 = C_amp_q.025*q.025,
         Conc_median = C_amp_median*Median,
         Conc_q.975 = C_amp_q.975*q.975)
```

join back to the tank metadata
```{r}
tank_metadata_biomass <- tank_metadata %>%
  select(site_name, AC_biomass, PC_biomass, WP_biomass) %>% 
  pivot_longer(cols = c(2:4), names_to = "Species", values_to = "biomass") %>%
  mutate(Species = str_remove(Species, "_biomass")) %>%
  mutate(Species = ifelse(Species == "AC", "Boreogadus saida",  Species),
         Species = ifelse(Species == "WP", "Gadus chalcogrammus", Species),
         Species = ifelse(Species == "PC", "Gadus macrocephalus", Species))

tank_metadata_abundance <- tank_metadata %>%
  select(site_name, AC_N, PC_N, WP_N) %>% 
  pivot_longer(cols = c(2:4), names_to = "Species", values_to = "N") %>%
  mutate(Species = str_remove(Species, "_N")) %>%
  mutate(N = ifelse(is.na(N), 0, N)) %>%
  mutate(Species = ifelse(Species == "AC", "Boreogadus saida",  Species),
         Species = ifelse(Species == "WP", "Gadus chalcogrammus", Species),
         Species = ifelse(Species == "PC", "Gadus macrocephalus", Species))

combined <- all_metabar %>%
  left_join(tank_metadata_biomass, by = c("site_name", "Species")) %>%
  left_join(tank_metadata_abundance, by = c("site_name", "Species")) %>%
  mutate(Species = ifelse(Species == "Boreogadus saida", "Arctic cod", Species),
         Species = ifelse(Species == "Gadus chalcogrammus", "Walleye pollock", Species),
         Species = ifelse(Species == "Gadus macrocephalus", "Pacific cod", Species))
```



the moment of truth.... plot biomass
```{r}
mypal <- c("#6a6599", "#79af97", "#00a1d5")   #purple, green, blue

combined %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species)) + 
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "log10(biomass (grams))",
       y = "log10(DNA copy number)") 

combined %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 

combined %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_median, color = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_median, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 
#hmm median looks really weird... 

```


okay, since the species estimates are not independent, plot just one species at a time??? 

```{r}
combined %>%
  filter(Species == "Arctic cod") %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  theme_classic() + 
  scale_color_manual(values = "#6a6599") + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 

combined %>%
  filter(Species == "Pacific cod") %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  theme_classic() + 
  scale_color_manual(values = "#79af97") + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 

combined %>%
  filter(Species == "Walleye pollock") %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
  theme_classic() + 
  scale_color_manual(values = "#00a1d5") + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 

fig_onecolor_zoom <- combined %>%
  filter(biomass < 5000) %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975), width = 0) +
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 
fig_onecolor_zoom

fig_onecolor <- combined %>%
  filter(biomass > 0) %>%
  ggplot() + 
  geom_point(aes(x=log10(biomass), y=Conc_mean), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975), width = 0) +
  theme_classic() + 
  scale_color_manual(values = mypal) + 
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)") 
fig_onecolor

```

```{r}
ggsave("my_figures/bm_cn.png", plot = fig_onecolor, width = 6, height = 4, dpi = 300)
ggsave("my_figures/bm_cn_zoom.png", plot = fig_onecolor_zoom, width = 6, height = 4, dpi = 300)
```



```{r}
#mod3 <- lm(Conc~biomass-1, data = combined)
#summary(mod3)
```

```{r}
#combined_2 <- combined %>%
#  filter(biomass < 5000)
#mod3.5 <- lm(10^Conc~biomass-1, data = combined_2)
#summary(mod3.5)
```



okay, i'm curious how a few of the tank variables may be influencing our relationships
1. temperature
2. number of species
3. dominate species 

```{r}
some_metadata <- my_data_filtered %>%
  select(site_name, Temp, N_spp, AC_Fbiomass, PC_Fbiomass, WP_Fbiomass, TankTime) %>%
  mutate(dominate = ifelse(AC_Fbiomass > PC_Fbiomass, "Arctic cod", NA),
         dominate = ifelse(WP_Fbiomass > AC_Fbiomass, "Walleye pollock", dominate),
         dominate = ifelse(PC_Fbiomass > WP_Fbiomass, "Pacific cod", dominate)) %>%
  select(site_name, Temp, N_spp, dominate, WP_Fbiomass, TankTime)
```


```{r}
combined <- combined %>%
  left_join(some_metadata, by = "site_name")

combined$N_spp <- as.factor(combined$N_spp)
```


make a nicer version of figure
```{r}
library(viridis)

fig_gradient <- combined %>%
  filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  ggplot() +
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = WP_Fbiomass, shape = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = WP_Fbiomass), width = 0) +
  theme_classic() +
  scale_color_viridis() +
  #scale_color_gradient2(low = "darkgreen", mid = "darkgrey", high = "purple", midpoint = 0.5, limits = c(0, 1), breaks = c(0.25, 0.5, 0.75)) +
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)",
       color = "Proportion of Walleye pollock biomass")
fig_gradient 

# combined %>%
#   filter(biomass > 0) %>%
#   filter(biomass < 5500) %>%
#   ggplot() +
#   geom_point(aes(x=log10(biomass), y=Conc_mean, color = Species), cex = 2) + 
#   geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = Species), width = 0) +
#   theme_classic() +
#   scale_color_manual(values = mypal) + 
#   geom_smooth(aes(x=log10(biomass), y=Conc_mean, color = Species), formula = y ~ x - 1, linetype = "dashed", method = "lm", se = FALSE) +
#   #scale_color_gradient2(low = "darkgreen", mid = "darkgrey", high = "purple", midpoint = 0.5, limits = c(0, 1), breaks = c(0.25, 0.5, 0.75)) +
#   labs(x = "log10(biomass)",
#        y = "log10 DNA copy number")

# low <- combined %>%
#   filter(biomass > 0) %>%
#   filter(biomass < 5500) %>%
#   filter(WP_Fbiomass < 0.3)
# 
# high <- combined %>%
#   filter(biomass > 0) %>%
#   filter(biomass < 5500) %>%
#   filter(WP_Fbiomass >= 0.3)

#low_mod <- lm(Conc~biomass-1, data = low)
#summary(low_mod)
#high_mod <- lm(Conc~biomass-1, data = high)
#summary(high_mod)

fig_binary <- combined %>%
  filter(biomass > 0) %>%
  #filter(biomass < 5500) %>%
  mutate(low_WP = ifelse(WP_Fbiomass < 0.3, "<0.3", ">=0.3")) %>%
  ggplot() +
  geom_point(aes(x=log10(biomass), y=Conc_mean, color = low_WP, shape = Species), cex = 2) + 
  geom_errorbar(aes(x=log10(biomass), y=Conc_mean, ymin = Conc_q.025, ymax = Conc_q.975, color = low_WP), width = 0) +
  scale_color_manual(values = c("lightblue", "darkblue")) +
  theme_classic() +
  #geom_smooth(aes(x=biomass,y=Conc, color = low_WP), formula = y ~ x - 1, linetype = "dashed", method = "lm", se = FALSE) +
  labs(x = "log10(biomass)",
       y = "log10(DNA copy number)",
       color = "Proportion of Walleye pollock biomass")
fig_binary 
```


```{r}
ggsave("my_figures/bm_cn_wp_gradient.png", plot = fig_gradient, width = 8, height = 4, dpi = 300)
ggsave("my_figures/bm_cn_wp_binary.png", plot = fig_binary, width = 8, height = 4, dpi = 300)
```


```{r, fig.width=10, fig.height=4}
library(patchwork)

combined_fig <- fig_gradient + fig_binary + 
  #plot_layout(guides = 'collect') + 
  plot_annotation(tag_levels = 'A') &
    theme(plot.tag = element_text(face = 'bold'))
combined_fig
```